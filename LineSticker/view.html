<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LINE 貼圖搜尋器</title>
  <style>
    :root{--b:#e5e7eb;--t:#111827;--muted:#6b7280;--bg:#fff;--accent:#111827;--chip:#f3f4f6}
    *{box-sizing:border-box}
    body{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Noto Sans TC,Arial;margin:24px;color:var(--t);background:var(--bg)}
    h1{font-size:22px;margin:0 0 10px}
    .muted{color:var(--muted)}
    .bar{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row{display:flex;gap:8px;align-items:center}
    .row.wrap{flex-wrap:wrap}
    input[type=text], select{padding:10px 12px;border:1px solid var(--b);border-radius:10px;font-size:15px;width:100%}
    button{padding:10px 14px;border:1px solid var(--b);background:#fff;border-radius:10px;cursor:pointer}
    button.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
    .panel{border:1px solid var(--b);border-radius:12px;padding:12px;margin-top:12px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:12px;margin-top:12px}
    .card{border:1px solid var(--b);border-radius:12px;padding:10px;display:flex;flex-direction:column;gap:6px}
    .card img{width:100%;height:auto;border-radius:8px}
    .title{font-weight:600}
    .small{font-size:12px;color:var(--muted)}
    .chip{display:inline-flex;align-items:center;gap:4px;background:var(--chip);border:1px solid var(--b);border-radius:999px;padding:2px 8px;font-size:12px;margin:2px}
    .chip button{border:none;background:transparent;cursor:pointer;padding:0 2px}
    .side{position:fixed;right:16px;top:16px;bottom:16px;width:340px;max-width:92vw;background:#fff;border:1px solid var(--b);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.08);padding:14px;display:none}
    .side.open{display:block}
    .side .hd{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .side .tags{display:flex;flex-wrap:wrap}
    .flex{display:flex;gap:8px}
    .grow{flex:1}
    .sep{height:1px;background:var(--b);margin:10px 0}
    .hint{font-size:13px;color:var(--muted)}
    .badge{display:inline-block;font-size:12px;padding:2px 6px;border:1px solid var(--b);border-radius:999px}
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .hidden{display:none}
    @media (max-width:900px){.bar{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <h1>LINE 貼圖搜尋器（重構版）</h1>
  <div class="hint">資料來源：合併檔 <code>_merged.json</code>（格式：[{ id, title, stickers[] } ...]）。可直接載入預設路徑或自選檔案。</div>

  <div class="panel">
    <div class="toolbar">
      <button id="loadDefault" class="primary">載入 ./json/_merged.json</button>
      <label class="row"><input id="file" type="file" accept="application/json" class="hidden"><button id="pick">選擇合併 JSON</button></label>
      <button id="exportNotes">匯出備註</button>
      <button id="importNotes">匯入備註</button>
      <label class="row"><input type="checkbox" id="onlyTagged"> 只看有備註</label>
    </div>

    <div class="bar" style="margin-top:12px">
      <div class="row">
        <select id="packSelect"><option value="">全部貼圖包</option></select>
      </div>
      <div class="row">
        <input id="search" type="text" placeholder="關鍵字搜尋（會搜尋：標題、ID、備註）">
        <button id="clearSearch">清除</button>
      </div>
    </div>
  </div>

  <div id="stats" class="hint" style="margin-top:6px"></div>

  <div id="results" class="grid"></div>

  <!-- 側邊備註面板 -->
  <div id="side" class="side" aria-hidden="true">
    <div class="hd">
      <div>
        <div id="sideTitle" class="title"></div>
        <div id="sideMeta" class="small"></div>
      </div>
      <button id="closeSide">✕</button>
    </div>
    <img id="sideImg" alt="preview" style="width:100%;border-radius:10px">
    <div class="sep"></div>
    <div class="hint">備註／關鍵字（多個）</div>
    <div id="sideTags" class="tags"></div>
    <div class="flex" style="margin-top:8px">
      <input id="tagInput" class="grow" type="text" placeholder="輸入備註後按 Enter">
      <button id="clearTags" title="清除此貼圖所有備註">清空</button>
    </div>
    <div class="sep"></div>
    <div class="hint">快速操作</div>
    <div class="row wrap">
      <a id="openCdn" class="badge" target="_blank" rel="noopener">開啟 CDN 連結</a>
      <button id="copyUrl" class="badge">複製圖片連結</button>
      <button id="copyId" class="badge">複製貼圖 ID</button>
    </div>
  </div>

  <script>
    // ========== 狀態 ==========
    /** @type {{id:string,title:string,stickers:number[]}[]} */
    let packs = [];
    /** 備註存放格式：{ [stickerId:string]: string[] } */
    let notes = loadNotes();

    // ========== DOM 快取 ==========
    const el = id => document.getElementById(id);
    const results = el('results');
    const packSelect = el('packSelect');
    const searchInput = el('search');
    const onlyTagged = el('onlyTagged');
    const stats = el('stats');

    // 側邊欄元素
    const side = el('side');
    const sideTitle = el('sideTitle');
    const sideMeta = el('sideMeta');
    const sideImg = el('sideImg');
    const sideTags = el('sideTags');
    const tagInput = el('tagInput');
    const openCdn = el('openCdn');
    let sideSticker = null; // {sid, title, pid}

    // ========== 初始化事件 ==========
    el('loadDefault').addEventListener('click', ()=> loadMerged('./json/_merged.json'));

    el('pick').addEventListener('click', ()=> el('file').click());
    el('file').addEventListener('change', async ()=>{
      const f = el('file').files?.[0];
      if(!f) return;
      try{
        const text = await f.text();
        const data = JSON.parse(text);
        useMergedData(data);
      }catch(err){
        alert('讀取失敗：'+err.message);
      }
    });

    packSelect.addEventListener('change', render);
    searchInput.addEventListener('input', render);
    el('clearSearch').addEventListener('click', ()=>{ searchInput.value=''; render(); });
    onlyTagged.addEventListener('change', render);

    el('closeSide').addEventListener('click', closeSide);
    el('clearTags').addEventListener('click', ()=>{ if(sideSticker){ setNotes(sideSticker.sid, []); renderTags(sideSticker.sid); render(); }});
    tagInput.addEventListener('keydown', (e)=>{
      if(e.key==='Enter'){
        const v = tagInput.value.trim();
        if(!v) return;
        if(sideSticker){ addNote(sideSticker.sid, v); renderTags(sideSticker.sid); render(); }
        tagInput.value='';
      }
    });

    el('copyUrl').addEventListener('click', ()=>{
      if(!sideSticker) return;
      navigator.clipboard.writeText(stickerUrl(sideSticker.sid));
    });
    el('copyId').addEventListener('click', ()=>{
      if(!sideSticker) return;
      navigator.clipboard.writeText(String(sideSticker.sid));
    });

    el('exportNotes').addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(notes, null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'sticker_notes.json';
      a.click();
    });

    el('importNotes').addEventListener('click', async()=>{
      const inp = document.createElement('input');
      inp.type = 'file'; inp.accept = 'application/json';
      inp.onchange = async ()=>{
        const f = inp.files?.[0]; if(!f) return;
        try{
          const text = await f.text();
          const obj = JSON.parse(text);
          if(obj && typeof obj === 'object'){
            notes = obj;
            saveNotes();
            render();
            if(sideSticker) renderTags(sideSticker.sid);
          }
        }catch(err){ alert('匯入失敗：'+err.message); }
      };
      inp.click();
    });

    // ========== 載入 & 資料使用 ==========
    async function loadMerged(url){
      try{
        const res = await fetch(url, {cache:'no-store'});
        if(!res.ok) throw new Error(res.status+' '+res.statusText);
        const data = await res.json();
        useMergedData(data);
      }catch(err){
        alert('載入失敗：'+err.message+'\n請確認路徑是否正確，或改用「選擇合併 JSON」載入。');
      }
    }

    function useMergedData(data){
      // 基本驗證與正規化
      if(!Array.isArray(data)) throw new Error('合併檔格式應為陣列');
      packs = data.map(x=>({
        id: String(x.id ?? ''),
        title: String(x.title ?? ''),
        stickers: Array.isArray(x.stickers) ? x.stickers.map(Number).filter(n=>Number.isFinite(n)) : []
      })).filter(p=>p.id && p.title && p.stickers.length);

      // 填下拉
      packSelect.innerHTML = '<option value="">全部貼圖包</option>' +
        packs.map(p=>`<option value="${escapeHtml(p.id)}">${escapeHtml(p.title)} (${escapeHtml(p.id)})</option>`).join('');

      render();
    }

    // ========== 渲染 ==========
    function render(){
      const sel = packSelect.value; // 空字串=全部
      const q = searchInput.value.trim().toLowerCase();
      const only = onlyTagged.checked;

      // 建立搜尋索引（簡易）：標題、id、備註
      const filteredPacks = packs.filter(p=> !sel || p.id===sel);
      const items = [];
      for(const p of filteredPacks){
        for(const sid of p.stickers){
          const tagList = (notes[String(sid)]||[]);
          if(only && tagList.length===0) continue;
          const hay = (p.title+' '+p.id+' '+tagList.join(' ')).toLowerCase();
          if(q && !hay.includes(q)) continue;
          items.push({pid:p.id, title:p.title, sid});
        }
      }

      stats.textContent = `目前顯示 ${items.length} 張貼圖（套數：${filteredPacks.length}/${packs.length}）`;

      // 生成格卡
      results.innerHTML = '';
      const frag = document.createDocumentFragment();
      for(const it of items){
        const card = document.createElement('div');
        card.className = 'card';
        const url = stickerUrl(it.sid);
        card.innerHTML = `
          <img loading="lazy" src="${url}" alt="${it.sid}">
          <div class="title small">${escapeHtml(it.title)} <span class="muted">#${it.pid}</span></div>
          <div class="small">ID：${it.sid}</div>
          <div class="tags" data-sid="${it.sid}">${renderTagChipsHtml(it.sid)}</div>
          <div class="row">
            <button data-open="${it.sid}">備註</button>
            <a class="badge" href="${url}" target="_blank" rel="noopener">CDN</a>
          </div>
        `;
        card.querySelector('[data-open]')?.addEventListener('click', ()=> openSide(it));
        frag.appendChild(card);
      }
      results.appendChild(frag);

      // 綁定 chip 刪除事件
      results.querySelectorAll('.chip[data-del]').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          const sid = btn.getAttribute('data-sid');
          const tag = btn.getAttribute('data-del');
          if(!sid||!tag) return;
          removeNote(sid, tag);
          // 局部更新這張卡的 tags 區塊
          const block = results.querySelector(`.tags[data-sid="${sid}"]`);
          if(block) block.innerHTML = renderTagChipsHtml(sid);
          // 如果只顯示有備註，可能需要重新過濾
          if(onlyTagged.checked) render();
          // 同步側邊欄
          if(sideSticker && String(sideSticker.sid)===String(sid)) renderTags(sid);
        });
      });
    }

    // ========== 側邊欄 ==========
    function openSide(it){
      sideSticker = it; // {pid, title, sid}
      sideTitle.textContent = it.title;
      sideMeta.textContent = `套件 #${it.pid}  ｜  貼圖 ID ${it.sid}`;
      sideImg.src = stickerUrl(it.sid);
      openCdn.href = stickerUrl(it.sid);
      renderTags(it.sid);
      side.classList.add('open');
      side.setAttribute('aria-hidden','false');
      tagInput.focus();
    }
    function closeSide(){
      side.classList.remove('open');
      side.setAttribute('aria-hidden','true');
      sideSticker = null;
    }
    function renderTags(sid){
      sideTags.innerHTML = renderTagChipsHtml(sid, true);
      // 綁定刪除
      sideTags.querySelectorAll('.chip[data-del]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const tag = btn.getAttribute('data-del');
          if(!tag) return;
          removeNote(String(sid), tag);
          renderTags(sid);
          render();
        });
      });
    }

    // ========== 備註（localStorage） ==========
    function loadNotes(){
      try{ return JSON.parse(localStorage.getItem('sticker_notes')||'{}')||{}; }catch{ return {} }
    }
    function saveNotes(){ localStorage.setItem('sticker_notes', JSON.stringify(notes)); }
    function addNote(sid, tag){
      const k = String(sid);
      const set = new Set(notes[k]||[]);
      set.add(tag);
      notes[k] = Array.from(set);
      saveNotes();
    }
    function removeNote(sid, tag){
      const k = String(sid);
      const arr = notes[k]||[];
      notes[k] = arr.filter(x=>x!==tag);
      if(notes[k].length===0) delete notes[k];
      saveNotes();
    }
    function setNotes(sid, arr){
      const k = String(sid);
      if(!arr || arr.length===0){ delete notes[k]; }
      else notes[k] = Array.from(new Set(arr));
      saveNotes();
    }
    function renderTagChipsHtml(sid, withX=false){
      const arr = notes[String(sid)]||[];
      if(arr.length===0) return '<span class="small muted">無備註</span>';
      return arr.map(t=>`<span class="chip">${escapeHtml(t)}${withX?`<button class="small" data-del="${escapeHtml(t)}" data-sid="${sid}" title="刪除此標籤">✕</button>`:''}</span>`).join('');
    }

    // ========== 工具 ==========
    function stickerUrl(id){
      return `https://stickershop.line-scdn.net/stickershop/v1/sticker/${id}/android/sticker.png`;
    }
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
    }

    // 預載可選：自動嘗試載入預設檔，可依需求改成註解
    loadMerged('./json/_merged.json');
  </script>
</body>
</html>
